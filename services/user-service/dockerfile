# --- Stage 1: Builder ---
# Use a Debian-based Go image with regular security updates instead of alpine-based golang image.
FROM golang:1.24-bullseye AS builder

# 1. รับชื่อ service
ARG SERVICE_NAME
WORKDIR /app

# 2. Copy dependencies (จากราก)
# Caching layer
COPY go.mod go.sum ./
RUN go mod download

# 3. Copy โค้ดที่แชร์ (ทุกคนต้องใช้)
COPY shared/ ./shared/

# 4. !! นี่คือส่วนที่ Optimize !!
# Copy "เฉพาะ" service ที่เรากำลังจะ build
COPY services/${SERVICE_NAME}/ ./services/${SERVICE_NAME}/

# 5. Build Service ที่ต้องการ
WORKDIR /app/services/${SERVICE_NAME}
RUN CGO_ENABLED=0 GOOS=linux go build -v -o /app/server .

# --- Stage 2: Final Image ---
# Use a minimal distroless runtime image to reduce attack surface and avoid Alpine package issues.
FROM gcr.io/distroless/static:nonroot
COPY --from=builder /app/server /server
USER nonroot

ENTRYPOINT ["/server"]
# CMD สำหรับ service นี้คือ "serve"
# นี่จะทำให้ container รันคำสั่ง "/server serve"
CMD ["serve"]